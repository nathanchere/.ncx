#!/bin/bash

# Really hacky way of determining if we are running in foreground or not
if [ ! -z `ps -o stat= | tail -n 1 | grep +` ]; then
  echo "Running in foreground; forking..."
  $0 &
  exit
fi

waitForAllTerminated() {
  end=$(($SECONDS+$1))
  while [ $SECONDS -lt $end ]; do
    if [[ -z `wmctrl -l` ]]; then
      return 0;
    fi
     sleep .05
  done
  return -1
}

for win in $(wmctrl -l | awk '{print $1}'); do
  wmctrl -ic $win
done

waitForAllTerminated 5

if [[ $? != 0 ]]; then
  notify-send -u critical "Cannot quit" "One or more windows cannot be closed"
  exit -1
fi

pkill xmonad
